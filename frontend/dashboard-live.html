<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRBot - Crypto Trading Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- FEATURE 6.1: i18n System -->
    <script src="/i18n/i18n.js"></script>
    <style>
        * { transition: all 0.3s ease; }
        .card-hover { @apply hover:shadow-2xl hover:scale-105; }
        .gradient-primary { background: linear-gradient(135deg, #10B981 0%, #059669 100%); }
        .gradient-danger { background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); }
        .profit { color: #10B981; }
        .loss { color: #EF4444; }
        .chart-container { position: relative; width: 100%; height: 300px; }
        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .pulse-dot { animation: pulse-dot 2s infinite; }
        .tab-active { @apply border-b-4 border-emerald-500 text-emerald-600; }
        .tab-inactive { @apply text-gray-500 hover:text-gray-700; }
        .loading { @apply opacity-50 pointer-events-none; }
        .error-message { @apply bg-red-900 text-red-100 p-4 rounded-lg mb-4; }
        .success-message { @apply bg-green-900 text-green-100 p-4 rounded-lg mb-4; }
    </style>
</head>
<body class="bg-slate-950 text-white font-sans">

<!-- HEADER -->
<nav class="bg-slate-900 border-b border-slate-700 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="text-3xl font-black gradient-primary bg-clip-text text-transparent">
                E CRBot
            </div>
            <span class="text-sm text-emerald-400">Crypto Trading Bot Platform</span>
        </div>
        <div class="flex items-center gap-6">
            <!-- FEATURE 6.1: Language Selector -->
            <div class="flex items-center gap-2">
                <label class="text-sm text-gray-400" data-i18n="common.language">Language</label>
                <select id="language-selector" class="bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm font-semibold text-emerald-400">
                    <option value="en">English</option>
                    <option value="fr">Français</option>
                    <option value="de" disabled>Deutsch (soon)</option>
                    <option value="es" disabled>Español (soon)</option>
                    <option value="zh" disabled>中文 (soon)</option>
                </select>
            </div>
            <div id="api-status" class="hidden md:flex items-center gap-1 bg-slate-800 px-3 py-2 rounded-lg">
                <span class="text-xs text-gray-400">API:</span>
                <span id="api-indicator" class="pulse-dot w-2 h-2 bg-red-500 rounded-full mx-1"></span>
                <span id="api-text" class="text-sm font-semibold text-red-400">OFFLINE</span>
            </div>
            <div class="flex items-center gap-3">
                <button class="p-2 hover:bg-slate-800 rounded-lg">
                    <i class="fas fa-bell text-xl"></i>
                </button>
                <button class="p-2 hover:bg-slate-800 rounded-lg">
                    <i class="fas fa-user-circle text-2xl"></i>
                </button>
            </div>
        </div>
    </div>
</nav>

<!-- MAIN CONTAINER -->
<div class="flex h-screen overflow-hidden">

<!-- SIDEBAR -->
<aside class="w-64 bg-slate-900 border-r border-slate-700 overflow-y-auto hidden md:flex flex-col">
    <div class="flex-1 p-6">
        <div class="space-y-2">
            <a href="#dashboard" onclick="showPage('dashboard')" class="sidebar-link active w-full text-left px-4 py-3 rounded-lg font-medium transition group bg-emerald-600 text-white flex items-center gap-3 whitespace-nowrap">
                <i class="fas fa-chart-line text-lg text-emerald-200 flex-shrink-0"></i>
                <span class="overflow-hidden text-ellipsis" data-i18n="sidebar.dashboard">Dashboard</span>
            </a>
            <a href="#charts" onclick="showPage('charts')" class="sidebar-link w-full text-left px-4 py-3 rounded-lg font-medium hover:bg-slate-800 transition group flex items-center gap-3 whitespace-nowrap">
                <i class="fas fa-candlestick-chart text-lg text-pink-400 flex-shrink-0"></i>
                <span class="group-hover:text-pink-400 overflow-hidden text-ellipsis" data-i18n="common.charts">Charts</span>
            </a>
            <a href="#markets" onclick="showPage('markets')" class="sidebar-link w-full text-left px-4 py-3 rounded-lg font-medium hover:bg-slate-800 transition group flex items-center gap-3 whitespace-nowrap">
                <i class="fas fa-globe text-lg text-blue-400 flex-shrink-0"></i>
                <span class="group-hover:text-blue-400 overflow-hidden text-ellipsis" data-i18n="sidebar.markets">Markets</span>
            </a>
            <a href="#bots" onclick="showPage('bots')" class="sidebar-link w-full text-left px-4 py-3 rounded-lg font-medium hover:bg-slate-800 transition group flex items-center gap-3 whitespace-nowrap">
                <i class="fas fa-robot text-lg text-purple-400 flex-shrink-0"></i>
                <span class="group-hover:text-purple-400 overflow-hidden text-ellipsis" data-i18n="sidebar.bots">Bots</span>
            </a>
            <a href="#reports" onclick="showPage('reports')" class="sidebar-link w-full text-left px-4 py-3 rounded-lg font-medium hover:bg-slate-800 transition group flex items-center gap-3 whitespace-nowrap">
                <i class="fas fa-chart-bar text-lg text-orange-400 flex-shrink-0"></i>
                <span class="group-hover:text-orange-400 overflow-hidden text-ellipsis" data-i18n="sidebar.reports">Reports</span>
            </a>
            <a href="#risk" onclick="showPage('risk')" class="sidebar-link w-full text-left px-4 py-3 rounded-lg font-medium hover:bg-slate-800 transition group flex items-center gap-3 whitespace-nowrap">
                <i class="fas fa-shield text-lg text-red-400 flex-shrink-0"></i>
                <span class="group-hover:text-red-400 overflow-hidden text-ellipsis" data-i18n="sidebar.risk">Risk</span>
            </a>
            <a href="#settings" onclick="showPage('settings')" class="sidebar-link w-full text-left px-4 py-3 rounded-lg font-medium hover:bg-slate-800 transition group flex items-center gap-3 whitespace-nowrap">
                <i class="fas fa-cog text-lg text-gray-400 flex-shrink-0"></i>
                <span class="group-hover:text-gray-400 overflow-hidden text-ellipsis">Settings</span>
            </a>
        </div>
    </div>
    <div class="p-6 border-t border-slate-700">
        <div id="sidebar-stats" class="text-xs text-gray-500 space-y-2">
            <p>Loading...</p>
        </div>
    </div>
</aside>

<!-- CONTENT -->
<main class="flex-1 overflow-y-auto">

<!-- ============ DASHBOARD PAGE ============ -->
<div id="dashboard" class="page-content p-6 md:p-8">
    <div id="dashboard-message"></div>
    
    <!-- KPI Cards -->
    <div id="dashboard-kpis" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl p-6 border border-slate-700 card-hover">
            <div class="flex justify-between items-start mb-4">
                <span class="text-sm text-gray-400" data-i18n="dashboard.portfolio_value">Portfolio Value</span>
                <i class="fas fa-wallet text-emerald-400 text-2xl"></i>
            </div>
            <h3 id="kpi-portfolio" class="text-3xl font-bold mb-2">-</h3>
            <p id="kpi-portfolio-change" class="text-sm text-gray-500" data-i18n="common.loading">Loading...</p>
        </div>

        <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl p-6 border border-slate-700 card-hover">
            <div class="flex justify-between items-start mb-4">
                <span class="text-sm text-gray-400" data-i18n="dashboard.daily_pnl">Daily P&L</span>
                <i class="fas fa-coins text-blue-400 text-2xl"></i>
            </div>
            <h3 id="kpi-daily-pnl" class="text-3xl font-bold profit mb-2">-</h3>
            <p id="kpi-daily-pnl-change" class="text-sm text-gray-500" data-i18n="common.loading">Loading...</p>
        </div>

        <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl p-6 border border-slate-700 card-hover">
            <div class="flex justify-between items-start mb-4">
                <span class="text-sm text-gray-400" data-i18n="dashboard.win_rate">Win Rate</span>
                <i class="fas fa-target text-purple-400 text-2xl"></i>
            </div>
            <h3 id="kpi-win-rate" class="text-3xl font-bold mb-2">-</h3>
            <p id="kpi-total-trades" class="text-sm text-gray-500" data-i18n="common.loading">Loading...</p>
        </div>

        <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl p-6 border border-slate-700 card-hover">
            <div class="flex justify-between items-start mb-4">
                <span class="text-sm text-gray-400" data-i18n="dashboard.max_drawdown">Max Drawdown</span>
                <i class="fas fa-chart-area text-orange-400 text-2xl"></i>
            </div>
            <h3 id="kpi-drawdown" class="text-3xl font-bold loss mb-2">-</h3>
            <p id="kpi-drawdown-info" class="text-sm text-gray-500">Loading...</p>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <!-- Equity Curve -->
        <div class="lg:col-span-2 bg-slate-800 rounded-xl p-6 border border-slate-700">
            <h3 class="text-lg font-bold mb-4">Equity Curve (30 days)</h3>
            <div class="chart-container">
                <canvas id="equityChart"></canvas>
            </div>
        </div>

        <!-- Portfolio Breakdown -->
        <div class="bg-slate-800 rounded-xl p-6 border border-slate-700">
            <h3 class="text-lg font-bold mb-4">Active Bots</h3>
            <div id="active-bots-list" class="space-y-3">
                <p class="text-gray-400">Loading...</p>
            </div>
        </div>
    </div>

    <!-- Recent Trades -->
    <div class="bg-slate-800 rounded-xl p-6 border border-slate-700">
        <h3 class="text-lg font-bold mb-4">Recent Trades</h3>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="border-b border-slate-700">
                    <tr class="text-gray-400">
                        <th class="text-left py-3 px-4">Symbol</th>
                        <th class="text-left py-3 px-4">Type</th>
                        <th class="text-right py-3 px-4">Entry</th>
                        <th class="text-right py-3 px-4">Exit</th>
                        <th class="text-right py-3 px-4">P&L</th>
                        <th class="text-center py-3 px-4">Status</th>
                    </tr>
                </thead>
                <tbody id="trades-table-body">
                    <tr><td colspan="6" class="text-center py-4 text-gray-400">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ============ OTHER PAGES (PLACEHOLDER) ============ -->
<div id="charts" class="page-content p-6 md:p-8 hidden">
    <iframe src="charts.html" style="width:100%; height:100vh; border:none; border-radius:0.75rem;"></iframe>
</div>

<div id="markets" class="page-content p-6 md:p-8 hidden">
    <h2 class="text-2xl font-bold mb-6">Markets & Analysis</h2>
    <p class="text-gray-400">Markets page coming soon...</p>
</div>

<div id="bots" class="page-content p-6 md:p-8 hidden">
    <h2 class="text-2xl font-bold mb-6">Bot Manager</h2>
    <p class="text-gray-400">Bots page coming soon...</p>
</div>

<div id="reports" class="page-content p-6 md:p-8 hidden">
    <h2 class="text-2xl font-bold mb-6">Reports & Analytics</h2>
    <p class="text-gray-400">Reports page coming soon...</p>
</div>

<div id="risk" class="page-content p-6 md:p-8 hidden">
    <h2 class="text-2xl font-bold mb-6">Risk Management</h2>
    <p class="text-gray-400">Risk page coming soon...</p>
</div>

<div id="settings" class="page-content p-6 md:p-8 hidden">
    <h2 class="text-2xl font-bold mb-6">Settings</h2>
    <p class="text-gray-400">Settings page coming soon...</p>
</div>

</main>
</div>

<script>
const API_BASE_URL = 'http://127.0.0.1:8002';

// ===================== API CALLS =====================
async function apiCall(endpoint) {
  try {
    console.log(`Fetching: ${API_BASE_URL}${endpoint}`);
    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
      method: 'GET',
      headers: { 'Content-Type': 'application/json' },
      mode: 'cors'
    });
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const data = await response.json();
    console.log(`Success [${endpoint}]:`, data);
    return data;
  } catch (error) {
    console.error(`API Error on ${endpoint}:`, error);
    return null;
  }
}

// ===================== PAGE NAVIGATION =====================
function showPage(pageName) {
  document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
  document.getElementById(pageName).classList.remove('hidden');
  
  document.querySelectorAll('.sidebar-link').forEach(link => {
    link.classList.remove('bg-emerald-600', 'text-white');
    link.classList.add('hover:bg-slate-800');
  });
  
  event.target.closest('.sidebar-link').classList.add('bg-emerald-600', 'text-white');
  
  // Load page-specific data
  if (pageName === 'dashboard') loadDashboard();
}

// ===================== DASHBOARD DATA =====================
async function loadDashboard() {
  // Load portfolio summary
  const summary = await apiCall('/api/portfolio/summary');
  if (summary) {
    document.getElementById('kpi-portfolio').textContent = `$${summary.portfolio_value.toLocaleString('en-US', {maximumFractionDigits: 2})}`;
    document.getElementById('kpi-daily-pnl').textContent = `$${summary.daily_pnl.toLocaleString('en-US', {maximumFractionDigits: 2})}`;
    document.getElementById('kpi-win-rate').textContent = `${summary.win_rate.toFixed(1)}%`;
    document.getElementById('kpi-drawdown').textContent = `${summary.max_drawdown.toFixed(1)}%`;
  }

  // Load equity curve
  const equityCurve = await apiCall('/api/portfolio/equity-curve?days=30');
  if (equityCurve && equityCurve.data) {
    updateEquityChart(equityCurve.data);
  }

  // Load trades
  const tradesData = await apiCall('/api/trades?limit=5');
  if (tradesData) {
    updateTradesTable(tradesData.trades);
  }

  // Load bots
  const botsData = await apiCall('/api/bots/list');
  if (botsData) {
    updateActiveBots(botsData.bots);
    updateSidebarStats(botsData.bots);
  }

  // Update API status
  updateAPIStatus(true);
}

// ===================== UI UPDATES =====================
function updateEquityChart(data) {
  const ctx = document.getElementById('equityChart');
  const dates = data.map(d => d.date ? new Date(d.date).toLocaleDateString() : '');
  const values = data.map(d => d.value || 0);

  if (ctx.chart) ctx.chart.destroy();
  
  ctx.chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [{
        label: 'Equity',
        data: values,
        borderColor: '#10B981',
        backgroundColor: 'rgba(16, 185, 129, 0.1)',
        fill: true,
        tension: 0.4,
        pointRadius: 2,
        pointBackgroundColor: '#10B981'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: {
          beginAtZero: false,
          grid: { color: '#334155', drawBorder: false },
          ticks: { color: '#94a3b8' }
        },
        x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
      }
    }
  });
}

function updateTradesTable(trades) {
  const tbody = document.getElementById('trades-table-body');
  
  if (!trades || trades.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-400">No trades found</td></tr>';
    return;
  }

  tbody.innerHTML = trades.map(trade => `
    <tr class="border-b border-slate-700 hover:bg-slate-700 transition">
      <td class="py-3 px-4 font-mono text-sm">${trade.symbol}</td>
      <td class="py-3 px-4">
        <span class="px-2 py-1 rounded text-xs ${trade.side === 'LONG' ? 'bg-emerald-900 text-emerald-100' : 'bg-red-900 text-red-100'}">
          ${trade.side}
        </span>
      </td>
      <td class="text-right py-3 px-4">$${trade.entry_price?.toFixed(2) || '-'}</td>
      <td class="text-right py-3 px-4">${trade.exit_price ? `$${trade.exit_price.toFixed(2)}` : '-'}</td>
      <td class="text-right py-3 px-4 ${trade.pnl_percent > 0 ? 'profit' : 'loss'}">
        ${trade.pnl_percent ? `${(trade.pnl_percent).toFixed(2)}%` : '-'}
      </td>
      <td class="text-center py-3 px-4">
        <span class="text-xs px-2 py-1 rounded ${trade.status === 'OPEN' ? 'bg-blue-900 text-blue-100' : 'bg-gray-900 text-gray-100'}">
          ${trade.status}
        </span>
      </td>
    </tr>
  `).join('');
}

function updateActiveBots(bots) {
  const list = document.getElementById('active-bots-list');
  const activeBots = bots.filter(b => b.status === 'RUNNING' || b.status === 'ACTIVE');
  
  if (!activeBots || activeBots.length === 0) {
    list.innerHTML = '<p class="text-gray-400">No active bots</p>';
    return;
  }

  list.innerHTML = activeBots.map(bot => `
    <div class="flex items-center justify-between p-3 bg-slate-700 rounded">
      <div class="flex-1">
        <p class="font-semibold text-sm">${bot.name}</p>
        <p class="text-xs text-gray-400">${bot.strategy}</p>
      </div>
      <div class="text-right">
        <p class="text-sm font-bold profit">${(bot.total_pnl || 0).toFixed(0)}</p>
        <p class="text-xs text-gray-400">${(bot.win_rate || 0).toFixed(1)}%</p>
      </div>
    </div>
  `).join('');
}

function updateSidebarStats(bots) {
  const stats = document.getElementById('sidebar-stats');
  const totalTrades = bots.reduce((sum, b) => sum + (b.total_trades || 0), 0);
  const avgWinRate = bots.length > 0 ? bots.reduce((sum, b) => sum + (b.win_rate || 0), 0) / bots.length : 0;
  const totalPnL = bots.reduce((sum, b) => sum + (b.total_pnl || 0), 0);

  stats.innerHTML = `
    <p>Trades: <span class="text-emerald-400 font-bold">${totalTrades}</span></p>
    <p>Avg Win Rate: <span class="text-emerald-400 font-bold">${avgWinRate.toFixed(1)}%</span></p>
    <p>Total P&L: <span class="text-emerald-400 font-bold">$${totalPnL.toFixed(0)}</span></p>
  `;
}

function updateAPIStatus(isOnline) {
  const indicator = document.getElementById('api-indicator');
  const text = document.getElementById('api-text');
  
  if (isOnline) {
    indicator.classList.remove('bg-red-500');
    indicator.classList.add('bg-emerald-500');
    text.classList.remove('text-red-400');
    text.classList.add('text-emerald-400');
    text.textContent = 'LIVE';
  } else {
    indicator.classList.remove('bg-emerald-500');
    indicator.classList.add('bg-red-500');
    text.classList.remove('text-emerald-400');
    text.classList.add('text-red-400');
    text.textContent = 'OFFLINE';
  }
}

// ===================== FEATURE 6.1: Language Management =====================
document.getElementById('language-selector').addEventListener('change', (e) => {
  const selectedLanguage = e.target.value;
  i18n.setLanguage(selectedLanguage);
  console.log(`Language changed to: ${selectedLanguage}`);
});

// ===================== INITIALIZATION =====================
document.addEventListener('DOMContentLoaded', () => {
  // Initialize language from localStorage
  const savedLanguage = localStorage.getItem('crbot_language') || 'en';
  document.getElementById('language-selector').value = savedLanguage;
  
  loadDashboard();
  // Refresh data every 10 seconds
  setInterval(loadDashboard, 10000);
});
</script>

</body>
</html>
